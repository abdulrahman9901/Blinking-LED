/**********************************************************************************************************************
 *  FILE DESCRIPTION
 *  -----------------------------------------------------------------------------------------------------------------*/
/**        \file  FileName.c
 *        \brief  
 *
 *      \details  
 *
 *
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  INCLUDES
 *********************************************************************************************************************/
#include "Std_Types.h"
#include "Platform_Types.h"
#include "Mcu_Hw.h"
#include "bitmath.h"
#include "systick.h"
#include "Compiler.h"

/**********************************************************************************************************************
*  LOCAL MACROS CONSTANT\FUNCTION
*********************************************************************************************************************/


/**********************************************************************************************************************
 *  LOCAL DATA 
 *********************************************************************************************************************/
static vuint32 ticksCount = 0;
static vuint32 overflow_count ;
static vboolean timer_is_counting = 0;
cb_type callback_ptr = NULL_PTR;
/**********************************************************************************************************************
 *  GLOBAL DATA
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL FUNCTION PROTOTYPES
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL FUNCTIONS
 *********************************************************************************************************************/
void SysTick_Handler(void) {
	ticksCount++;

	if (ticksCount >= overflow_count) {
		timer_is_counting = FALSE;
		ticksCount = 0;
	}
	if(NULL_PTR != callback_ptr) {
		callback_ptr();
	}
}
/**********************************************************************************************************************
 *  GLOBAL FUNCTIONS
 *********************************************************************************************************************/
void register_Systick_CB(cb_type  callback){
	if(NULL_PTR != callback) {
		callback_ptr = callback ;
	}
}
void Systick_init(){
	
	//Value to load into the SysTick Current Value (STCURRENT) register
    SYSTICK->STRELOAD = 16000;
	/**Enable the timer */
    SET_BIT(SYSTICK->STCTRL,0);
	/*Clear STCURRENT */
	SYSTICK->STCURRENT = 0X00004000;
    /**	Clock Source : Precision internal oscillator (PIOSC) divided by 4*/
    CLEAR_BIT(SYSTICK->STCTRL,2);
}

void delay_ms(uint32 time_in_ms){
    
	overflow_count = time_in_ms;
	timer_is_counting = TRUE; 			

	//starts counting
    SET_BIT(SYSTICK->STCTRL,1);

	while (timer_is_counting);

	//stop counting
    CLEAR_BIT(SYSTICK->STCTRL,1);

	//reset counter
	SYSTICK->STCURRENT = 0;
}

/**********************************************************************************************************************
 *  END OF FILE: FileName.c
 *********************************************************************************************************************/
